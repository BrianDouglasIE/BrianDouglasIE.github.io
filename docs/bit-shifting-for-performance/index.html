<!DOCTYPE html>
<html lang="en" class="Robyn">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- Title -->
        <title>Brian Douglas' Tech Blog - Bit shifting to increase performance</title>

        <!-- Meta Description -->
        <meta name="description" content="Bit shifting to increase performance" />

        <!-- Keywords -->
        <meta
            name="keywords"
            content="Brian Douglas, tech blog, javascript,performance"
        />

        <!-- Author -->
        <meta name="author" content="Brian Douglas" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta
            property="og:title"
            content="Brian Douglas' Tech Blog - Bit shifting to increase performance"
        />
        <meta property="og:description" content="Bit shifting to increase performance" />
        <meta property="og:url" content="https://www.briandouglas.ie" />
        <meta
            property="og:image"
            content="https://www.briandouglas.ie/images/og-images/bit-shifting-for-performance.png"
        />
        <meta property="og:site_name" content="Brian Douglas' Tech Blog" />

        <!-- Twitter Meta -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta
            name="twitter:title"
            content="Brian Douglas' Tech Blog - Bit shifting to increase performance"
        />
        <meta name="twitter:description" content="Bit shifting to increase performance" />
        <meta
            name="twitter:image"
            content="https://www.briandouglas.ie/images/og-images/bit-shifting-for-performance.png"
        />
        <meta name="twitter:site" content="@BrianDouglasIE" />

        <!-- Canonical URL -->
        <link rel="canonical" href="https://www.briandouglas.ie" />

        <!-- Favicon (Optional) -->
        <link
            rel="icon"
            href="https://www.briandouglas.ie/favicon.ico"
            type="image/x-icon"
        />

        <!-- Robots -->
        <meta name="robots" content="index, follow" />

        <!-- Favicon-->
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon-16x16.png"
        />
        <link rel="manifest" href="/site.webmanifest" />

        <link rel="stylesheet" href="/styles/briandouglas.ie.css">
    </head>
    <body class="m-0">
        <header class="site-header">
    <div class="content-md mx-auto px-sm">
        <h1 class="m-0">Brian Douglas</h1>
    </div>
</header>

        <div class="breadcrumbs">
            <nav aria-label="Breadcrumb" class="content-md mx-auto px-sm">
                <ol class="list-reset m-0">
                    <li><a href="/">Home</a></li> /
                    <li aria-current="page">Bit shifting to increase performance</li>
                </ol>
            </nav>
        </div>
        <main>
            <div class="content-md mx-auto px-sm my-md">
                <article class="post-full">
                    <header>
                        <h2>Bit shifting to increase performance</h2>
                        <p class="post-meta">
                            <time datetime="15/09/2024"
                            >September 15th, 2024</time>
                        </p>
                    </header>
                    <div class="post-content"><p>I've been watching <a href="https://www.youtube.com/@Vercidium">@Vercidium</a>'s awesome content on YouTube. His videos are all
about performance optimization in regards to game development, and I learned a nifty performance optimization for my
JS code as a result.</p>
<!-- more -->
<p>In his <a href="https://youtu.be/40JzyaOYJeY?si=5J97q3bm7MsJ3I6k">&quot;I Optimised My Game Engine Up To 12000 FPS&quot;</a> video Vercidium
shows a <em>bit-shifting</em> technique which he has used to store information about his voxel based scene. This got me
thinking
<em>could the same technique be used to save memory in JS code?</em>.</p>
<magpie-trinket>
<p><strong>TLDR;</strong> Storing a vector (x, y, z) as a 32-bit number uses a seventh of the memory compared to storing
it as an object in this example.</p>
<table class="pure-table">
    <thead>
        <tr>
            <th>Metric</th>
            <th>Object Based</th>
            <th>Bit Shifted</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>RSS</td>
            <td>646.12 MB</td>
            <td>132.29 MB</td>
        </tr>
        <tr>
            <td>Heap Total</td>
            <td>576.83 MB</td>
            <td>87.58 MB</td>
        </tr>
        <tr>
            <td>Heap Used</td>
            <td>545.67 MB</td>
            <td>82.33 MB</td>
        </tr>
        <tr>
            <td>External</td>
            <td>0.98 MB</td>
            <td>0.98 MB</td>
        </tr>
        <tr>
            <td>Array Buffers</td>
            <td>0.01 MB</td>
            <td>0.01 MB</td>
        </tr>
    </tbody>
</table>
</magpie-trinket>
<h2>The Plan</h2>
<p>When creating games and rendering scenes on canvas I often start by creating a <code>Vector</code> class like the one below.</p>
<pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#D73A49">class</span><span style="color:#6F42C1"> Vector3</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#E36209">    x</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 0</span></span>
<span class="line"><span style="color:#E36209">    y</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 0</span></span>
<span class="line"><span style="color:#E36209">    z</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">    constructor</span><span style="color:#24292E">(</span><span style="color:#E36209">x</span><span style="color:#24292E">, </span><span style="color:#E36209">y</span><span style="color:#24292E">, </span><span style="color:#E36209">z</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#005CC5">        this</span><span style="color:#24292E">.x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> x</span></span>
<span class="line"><span style="color:#005CC5">        this</span><span style="color:#24292E">.y </span><span style="color:#D73A49">=</span><span style="color:#24292E"> y</span></span>
<span class="line"><span style="color:#005CC5">        this</span><span style="color:#24292E">.z </span><span style="color:#D73A49">=</span><span style="color:#24292E"> z</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre>
<p>You'll see varying implementations of this in pretty much every game engine. It's used to define where something
exists with in the game world. In my JS games I'll sometimes create tens of thousands of these at a time. I've often
thought about the performance impact of this, but never really came up with a good solution. The games I make are
often rudimentary in nature.</p>
<p>So let's look at the amount of memory used by creating and modifying such objects. To record the memory usage I have
written the following method. Which breaks down the results as follows:</p>
<ul>
<li>rss: Resident Set Size – total memory allocated for the process.</li>
<li>heapTotal: Total size of the allocated heap.</li>
<li>heapUsed: Actual memory used by the program.</li>
<li>external: Memory used by C++ objects bound to JavaScript objects.</li>
<li>arrayBuffers: Memory allocated for ArrayBuffers and SharedArrayBuffers.</li>
</ul>
<pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> logMemoryUsage</span><span style="color:#24292E">() {</span></span>
<span class="line"><span style="color:#D73A49">    const</span><span style="color:#005CC5"> memoryUsage</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> process.</span><span style="color:#6F42C1">memoryUsage</span><span style="color:#24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">    console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(</span><span style="color:#032F62">`Memory Usage:</span></span>
<span class="line"><span style="color:#032F62">        RSS: ${</span><span style="color:#24292E">memoryUsage</span><span style="color:#032F62">.</span><span style="color:#24292E">rss</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#032F62">} MB</span></span>
<span class="line"><span style="color:#032F62">        Heap Total: ${</span><span style="color:#24292E">memoryUsage</span><span style="color:#032F62">.</span><span style="color:#24292E">heapTotal</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#032F62">} MB</span></span>
<span class="line"><span style="color:#032F62">        Heap Used: ${</span><span style="color:#24292E">memoryUsage</span><span style="color:#032F62">.</span><span style="color:#24292E">heapUsed</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#032F62">} MB</span></span>
<span class="line"><span style="color:#032F62">        External: ${</span><span style="color:#24292E">memoryUsage</span><span style="color:#032F62">.</span><span style="color:#24292E">external</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#032F62">} MB</span></span>
<span class="line"><span style="color:#032F62">        Array Buffers: ${</span><span style="color:#24292E">memoryUsage</span><span style="color:#032F62">.</span><span style="color:#24292E">arrayBuffers</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#D73A49"> /</span><span style="color:#005CC5"> 1024</span><span style="color:#032F62">} MB</span></span>
<span class="line"><span style="color:#032F62">    `</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre>
<p>The below script creates <strong>10 million</strong> <code>Vector3</code> objects and updates the <code>x</code> and <code>y</code> co-ordinates of each randomly
every
millisecond for 2 seconds.</p>
<pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#D73A49">class</span><span style="color:#6F42C1"> Vector3</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#E36209">    x</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 0</span></span>
<span class="line"><span style="color:#E36209">    y</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 0</span></span>
<span class="line"><span style="color:#E36209">    z</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">    constructor</span><span style="color:#24292E">(</span><span style="color:#E36209">x</span><span style="color:#24292E">, </span><span style="color:#E36209">y</span><span style="color:#24292E">, </span><span style="color:#E36209">z</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#005CC5">        this</span><span style="color:#24292E">.x </span><span style="color:#D73A49">=</span><span style="color:#24292E"> x</span></span>
<span class="line"><span style="color:#005CC5">        this</span><span style="color:#24292E">.y </span><span style="color:#D73A49">=</span><span style="color:#24292E"> y</span></span>
<span class="line"><span style="color:#005CC5">        this</span><span style="color:#24292E">.z </span><span style="color:#D73A49">=</span><span style="color:#24292E"> z</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> randomNumber</span><span style="color:#24292E">(</span><span style="color:#E36209">min</span><span style="color:#24292E">, </span><span style="color:#E36209">max</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> Math.</span><span style="color:#6F42C1">floor</span><span style="color:#24292E">(Math.</span><span style="color:#6F42C1">random</span><span style="color:#24292E">() </span><span style="color:#D73A49">*</span><span style="color:#24292E"> max) </span><span style="color:#D73A49">+</span><span style="color:#24292E"> min;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> maxVectors</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 10_000_000</span></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> vectors</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> Array</span><span style="color:#24292E">(maxVectors)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">let</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&#x3C;</span><span style="color:#24292E"> maxVectors; i</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    vectors[i] </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> Vector3</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#6F42C1">        randomNumber</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">1000</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#6F42C1">        randomNumber</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">1000</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#6F42C1">        randomNumber</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">1000</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">    )</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">let</span><span style="color:#24292E"> demoLengthInSeconds </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 2</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> updateInterval</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> setInterval</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">const</span><span style="color:#005CC5"> v</span><span style="color:#D73A49"> of</span><span style="color:#24292E"> vectors) {</span></span>
<span class="line"><span style="color:#24292E">        v.x </span><span style="color:#D73A49">+=</span><span style="color:#6F42C1"> randomNumber</span><span style="color:#24292E">(</span><span style="color:#D73A49">-</span><span style="color:#005CC5">2</span><span style="color:#24292E">, </span><span style="color:#005CC5">2</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">        v.y </span><span style="color:#D73A49">+=</span><span style="color:#6F42C1"> randomNumber</span><span style="color:#24292E">(</span><span style="color:#D73A49">-</span><span style="color:#005CC5">2</span><span style="color:#24292E">, </span><span style="color:#005CC5">2</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">}, </span><span style="color:#005CC5">1</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">setTimeout</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6F42C1">    logMemoryUsage</span><span style="color:#24292E">()</span></span>
<span class="line"><span style="color:#6F42C1">    clearInterval</span><span style="color:#24292E">(updateInterval)</span></span>
<span class="line"><span style="color:#24292E">}, demoLengthInSeconds </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 1000</span><span style="color:#24292E">)</span></span></code></pre>
<p>For the purposes of this article I will run the script with node. Which gives the following results.</p>
<pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code class="language-text"><span class="line"><span>Memory Usage:</span></span>
<span class="line"><span>        RSS: 646.12109375 MB</span></span>
<span class="line"><span>        Heap Total: 576.828125 MB</span></span>
<span class="line"><span>        Heap Used: 545.6746520996094 MB</span></span>
<span class="line"><span>        External: 0.9788284301757812 MB</span></span>
<span class="line"><span>        Array Buffers: 0.009958267211914062 MB</span></span></code></pre>
<p>Using the above object based implementation as baseline, let's now look at the bit-shifter variant.</p>
<h2>The Bit Shifter Implementation</h2>
<p>The bit-shifting implementation is going to work along the same lines. However, some boilerplate code is needed to <code>pack</code>
and <code>unpack</code> our vector's values. Essentially what we are doing with the <code>pack</code> method is a mask and shift of <code>x</code>, <code>y</code>,
and <code>z</code> to pack them efficiently into a single 32-bit number. The idea here being that a 32-bit number will be stored
with less memory than the class used in the object based run.</p>
<p>Putting these concepts into practice we have the below script.</p>
<pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> pack</span><span style="color:#24292E">(</span><span style="color:#E36209">n</span><span style="color:#24292E">, </span><span style="color:#E36209">offset</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">offset) </span><span style="color:#D73A49">return</span><span style="color:#24292E"> (n </span><span style="color:#D73A49">&#x26;</span><span style="color:#005CC5"> 0x3FF</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> (n </span><span style="color:#D73A49">&#x26;</span><span style="color:#005CC5"> 0x3FF</span><span style="color:#24292E">) </span><span style="color:#D73A49">&#x3C;&#x3C;</span><span style="color:#24292E"> offset;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> Vector3</span><span style="color:#24292E">(</span><span style="color:#E36209">x</span><span style="color:#24292E">, </span><span style="color:#E36209">y</span><span style="color:#24292E">, </span><span style="color:#E36209">z</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> (</span><span style="color:#6F42C1">pack</span><span style="color:#24292E">(x, </span><span style="color:#005CC5">20</span><span style="color:#24292E">) </span><span style="color:#D73A49">|</span><span style="color:#6F42C1"> pack</span><span style="color:#24292E">(y, </span><span style="color:#005CC5">10</span><span style="color:#24292E">) </span><span style="color:#D73A49">|</span><span style="color:#6F42C1"> pack</span><span style="color:#24292E">(z));</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> unpack</span><span style="color:#24292E">(</span><span style="color:#E36209">packed</span><span style="color:#24292E">, </span><span style="color:#E36209">offset</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">offset) </span><span style="color:#D73A49">return</span><span style="color:#24292E"> packed </span><span style="color:#D73A49">&#x26;</span><span style="color:#005CC5"> 0x3FF</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> (packed </span><span style="color:#D73A49">>></span><span style="color:#24292E"> offset) </span><span style="color:#D73A49">&#x26;</span><span style="color:#005CC5"> 0x3FF</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> getX</span><span style="color:#24292E">(</span><span style="color:#E36209">vector3</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#6F42C1"> unpack</span><span style="color:#24292E">(vector3, </span><span style="color:#005CC5">20</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> getY</span><span style="color:#24292E">(</span><span style="color:#E36209">vector3</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#6F42C1"> unpack</span><span style="color:#24292E">(vector3, </span><span style="color:#005CC5">10</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> getZ</span><span style="color:#24292E">(</span><span style="color:#E36209">vector3</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#6F42C1"> unpack</span><span style="color:#24292E">(vector3);</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> setX</span><span style="color:#24292E">(</span><span style="color:#E36209">vector3</span><span style="color:#24292E">, </span><span style="color:#E36209">x</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    vector3 </span><span style="color:#D73A49">&#x26;=</span><span style="color:#D73A49"> ~</span><span style="color:#24292E">(</span><span style="color:#005CC5">0x3FF</span><span style="color:#D73A49"> &#x3C;&#x3C;</span><span style="color:#005CC5"> 20</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">    vector3 </span><span style="color:#D73A49">|=</span><span style="color:#6F42C1"> pack</span><span style="color:#24292E">(x, </span><span style="color:#005CC5">20</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> vector3;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> setY</span><span style="color:#24292E">(</span><span style="color:#E36209">vector3</span><span style="color:#24292E">, </span><span style="color:#E36209">y</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    vector3 </span><span style="color:#D73A49">&#x26;=</span><span style="color:#D73A49"> ~</span><span style="color:#24292E">(</span><span style="color:#005CC5">0x3FF</span><span style="color:#D73A49"> &#x3C;&#x3C;</span><span style="color:#005CC5"> 10</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#24292E">    vector3 </span><span style="color:#D73A49">|=</span><span style="color:#6F42C1"> pack</span><span style="color:#24292E">(y, </span><span style="color:#005CC5">10</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> vector3;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> setZ</span><span style="color:#24292E">(</span><span style="color:#E36209">vector3</span><span style="color:#24292E">, </span><span style="color:#E36209">z</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    vector3 </span><span style="color:#D73A49">&#x26;=</span><span style="color:#D73A49"> ~</span><span style="color:#005CC5">0x3FF</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">    vector3 </span><span style="color:#D73A49">|=</span><span style="color:#6F42C1"> pack</span><span style="color:#24292E">(z);</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> vector3;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> randomNumber</span><span style="color:#24292E">(</span><span style="color:#E36209">min</span><span style="color:#24292E">, </span><span style="color:#E36209">max</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> Math.</span><span style="color:#6F42C1">floor</span><span style="color:#24292E">(Math.</span><span style="color:#6F42C1">random</span><span style="color:#24292E">() </span><span style="color:#D73A49">*</span><span style="color:#24292E"> max) </span><span style="color:#D73A49">+</span><span style="color:#24292E"> min;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> maxVectors</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 10_000_000</span></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> vectors</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> Array</span><span style="color:#24292E">(maxVectors)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">let</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&#x3C;</span><span style="color:#24292E"> maxVectors; i</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    vectors[i] </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> Vector3</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#6F42C1">        randomNumber</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">1000</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#6F42C1">        randomNumber</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">1000</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#6F42C1">        randomNumber</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">1000</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">    )</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">let</span><span style="color:#24292E"> demoLengthInSeconds </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 2</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> updateInterval</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> setInterval</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">    for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">const</span><span style="color:#005CC5"> v</span><span style="color:#D73A49"> of</span><span style="color:#24292E"> vectors) {</span></span>
<span class="line"><span style="color:#6F42C1">        setX</span><span style="color:#24292E">(v, </span><span style="color:#6F42C1">getX</span><span style="color:#24292E">(v) </span><span style="color:#D73A49">+</span><span style="color:#6F42C1"> randomNumber</span><span style="color:#24292E">(</span><span style="color:#D73A49">-</span><span style="color:#005CC5">2</span><span style="color:#24292E">, </span><span style="color:#005CC5">2</span><span style="color:#24292E">))</span></span>
<span class="line"><span style="color:#6F42C1">        setY</span><span style="color:#24292E">(v, </span><span style="color:#6F42C1">getY</span><span style="color:#24292E">(v) </span><span style="color:#D73A49">+</span><span style="color:#6F42C1"> randomNumber</span><span style="color:#24292E">(</span><span style="color:#D73A49">-</span><span style="color:#005CC5">2</span><span style="color:#24292E">, </span><span style="color:#005CC5">2</span><span style="color:#24292E">))</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">}, </span><span style="color:#005CC5">1</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">setTimeout</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6F42C1">    logMemoryUsage</span><span style="color:#24292E">()</span></span>
<span class="line"><span style="color:#6F42C1">    clearInterval</span><span style="color:#24292E">(updateInterval)</span></span>
<span class="line"><span style="color:#24292E">}, demoLengthInSeconds </span><span style="color:#D73A49">*</span><span style="color:#005CC5"> 1000</span><span style="color:#24292E">)</span></span></code></pre>
<chicken-asks>
Will the calls to `pack` and `unpack` affect the performance?
</chicken-asks>
<magpie-replies>
Good question, there may be a more efficient way of doing this. But in regard to this test, the impact of calling `pack`
and `unpack` seem to be negligible.
</magpie-replies>
<p>Again this is run with node, <code>v18.19.0</code>. The resulting memory usage is as follows.</p>
<pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code class="language-text"><span class="line"><span>Memory Usage:</span></span>
<span class="line"><span>        RSS: 132.28515625 MB</span></span>
<span class="line"><span>        Heap Total: 87.578125 MB</span></span>
<span class="line"><span>        Heap Used: 82.33492279052734 MB</span></span>
<span class="line"><span>        External: 0.9788284301757812 MB</span></span>
<span class="line"><span>        Array Buffers: 0.009958267211914062 MB</span></span></code></pre>
<h2>The Results</h2>
<table class="pure-table">
    <thead>
        <tr>
            <th>Metric</th>
            <th>Object Based</th>
            <th>Bit Shifted</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>RSS</td>
            <td>646.12 MB</td>
            <td>132.29 MB</td>
        </tr>
        <tr>
            <td>Heap Total</td>
            <td>576.83 MB</td>
            <td>87.58 MB</td>
        </tr>
        <tr>
            <td>Heap Used</td>
            <td>545.67 MB</td>
            <td>82.33 MB</td>
        </tr>
        <tr>
            <td>External</td>
            <td>0.98 MB</td>
            <td>0.98 MB</td>
        </tr>
        <tr>
            <td>Array Buffers</td>
            <td>0.01 MB</td>
            <td>0.01 MB</td>
        </tr>
    </tbody>
</table>
<p>As we can see from the above table the object based implementation used around <strong>7 times</strong> more memory than the bit
shifted example.</p>
<p>When it comes to creating my next game I will certainly be using this technique. While it does require extra code, the
code required is still fairly minimal. Especially seeing as it uses a seventh of the memory.</p>
</div>
                    <footer>
                        <p>Until next time,</p>
                        <p>— Brian</p>
                    </footer>
                </article>
            </div>
        </main>
        <footer class="site-footer gray-bg">
    <div class="content-md mx-auto px-sm">
        <p class="my-auto py-sm">
            Since August 4th, 2023. All words by Brian
            Douglas.
        </p>
    </div>
</footer>

        <script src="/scripts/chicken-and-magpie.js"></script>
    </body>
</html>
