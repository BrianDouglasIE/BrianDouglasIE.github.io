<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Title -->
    <title>Brian Douglas' Tech Blog - Generate OG images for blog posts</title>

    <!-- Meta Description -->
    <meta name="description" content="Generate OG images for blog posts">

    <!-- Keywords -->
    <meta name="keywords"
          content="Brian Douglas, tech blog, node,javascript">

    <!-- Author -->
    <meta name="author" content="Brian Douglas">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Brian Douglas' Tech Blog - Generate OG images for blog posts">
    <meta property="og:description"
          content="Generate OG images for blog posts">
    <meta property="og:url" content="https://www.briandouglas.ie">
    <meta property="og:image" content="https://www.briandouglas.ie/images/og-images/generate-og-images-for-blog-posts.png">
    <meta property="og:site_name" content="Brian Douglas' Tech Blog">

    <!-- Twitter Meta -->s
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Brian Douglas' Tech Blog - Generate OG images for blog posts">
    <meta name="twitter:description"
          content="Generate OG images for blog posts">
    <meta name="twitter:image" content="https://www.briandouglas.ie/images/og-images/generate-og-images-for-blog-posts.png">
    <meta name="twitter:site" content="@BrianDouglasIE">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.briandouglas.ie">

    <!-- Favicon (Optional) -->
    <link rel="icon" href="https://www.briandouglas.ie/favicon.ico" type="image/x-icon">

    <!-- Robots -->
    <meta name="robots" content="index, follow">

    <!-- Favicon-->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <link rel="stylesheet" href="/styles/external/pure.min.css">
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
<div class="wrapper">
    <header class="site-header">
    <nav class="container">
        <ul class="reset-list">
            <li><a href="/" class="reset-a"><h1 class="m-0">Brian Douglas</h1></a></li>
        </ul>
    </nav>
</header>
    <div class="breadcrumbs">
        <div class="container">
            <nav aria-label="Breadcrumb" class="breadcrumb">
                <ol>
                    <li><a href="/">Home</a></li>
                    <li aria-current="page">Generate OG images for blog posts</li>
                </ol>
            </nav>
        </div>
    </div>
    <main>
        <div class="container">
            <article class="post-full">
                <header>
                    <h2>Generate OG images for blog posts</h2>
                    <p class="post-meta">Published on
                        <time datetime="07/09/2024">September 7th, 2024</time>
                        by Brian
                    </p>
                </header>
                <p class="post-content"><p>When sharing an article on social media you will see a preview. The preview uses the html <code>og:image</code> meta tag. In this
article I will demonstrate how I generate a unique <code>og:image</code> for each of my blog posts.</p>
<!-- more -->

<p>The general gist here is that we want to create a method that will take the title of our post and generate an image
with that title text. We will use a template image to place the text into. The template image I use is shown below.
Note the empty space on the right hand side, this is where we will place our blog post title. As recommended by github
I have also left and 80px margin around the content. The dimensions of the image are 1280x640 pixels.</p>
<img class="pure-img" src="/images/open-graph-template.png"  alt="my og:image template"/>

<h2>The Implementation</h2>
<p>In order to write the title of our blog post to the template image we will use the npm package <a href="https://www.npmjs.com/package/pureimage">PureImage</a>.
This package allows us to use the canvas api to draw to a context which we can then export as an image, without loading
up a browser instance.</p>
<magpie-trinket>
He probably leaves out a load of detail in the next section. But the general gist is as follows.
<ul>
    <li>Create a template image that you want to write too</li>
    <li>Install the PureImage package</li>
    <li>Load the desired font intro PureImage</li>
    <li>Draw the text on to the template image using a PureImage context</li>
    <li>Output the new image to the desired location</li>
</ul>
</magpie-trinket>

<h3>Gotcha 1 - Loading the font</h3>
<p>The first gotcha when using <code>PureImage</code> is that there are no fonts loaded by default. So in order to draw text to our image
we must first load the font like so.</p>
<pre><code class="language-javascript">import * as PImage from &quot;pureimage&quot;;

const OUT_DIR = &quot;./docs/images/og-images&quot;;
const FONT = PImage.registerFont(
  &quot;C:\\Users\\brian\\AppData\\Local\\Microsoft\\Windows\\Fonts\\JetBrainsMono-Bold.ttf&quot;,
  &quot;MyFont&quot;,
);

FONT.loadSync();
</code></pre>
<p>This will load the required font so that we can use it when drawing on our image template.</p>
<h3>Gotcha 2 - Wrapping the text</h3>
<p>The second gotcha is that because we are using the canvas api to draw text, it will not wrap unless we specifically tell
it to do so. To get around this I have used the below method. This is actually a common issue when making browser games
using the canvas. So I was expecting to encounter the problem.</p>
<pre><code class="language-javascript">function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(&quot; &quot;);
  let line = &quot;&quot;;
  let testLine, metrics, testWidth;

  for (let n = 0; n &lt; words.length; n++) {
    testLine = line + words[n] + &quot; &quot;;
    metrics = ctx.measureText(testLine);
    testWidth = metrics.width;

    if (testWidth &gt; maxWidth &amp;&amp; n &gt; 0) {
      ctx.fillText(line, x, y);
      line = words[n] + &quot; &quot;;
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}
</code></pre>
<h3>Putting it all together</h3>
<p>Here is the code I use to generate my OG images. It&#39;s specific to my use case, but I feel that you, a talented software
engineer, will be able to extract the bits you need.</p>
<p>The main domain specific things here is that my <code>Post</code> class looks something like this.</p>
<pre><code class="language-typescript">type Post = {
    slug: string
    html: string
    excerpt: string
    data: { title: string, date: string, tags: string[] }
}
</code></pre>
<p>With that in mind here is the full implementation.</p>
<pre><code class="language-javascript">import * as PImage from &quot;pureimage&quot;;
import * as fs from &quot;fs&quot;;
import path from &quot;node:path&quot;;

const OUT_DIR = &quot;./docs/images/og-images&quot;;
const FONT = PImage.registerFont(
  &quot;C:\\Users\\brian\\AppData\\Local\\Microsoft\\Windows\\Fonts\\JetBrainsMono-Bold.ttf&quot;,
  &quot;MyFont&quot;,
);

FONT.loadSync();

export async function generateOGImage(post) {
  const pImage = PImage.make(1280, 640);
  const ctx = pImage.getContext(&quot;2d&quot;);
  const image = await PImage.decodePNGFromStream(
    fs.createReadStream(&quot;./theme/assets/images/open-graph-template.png&quot;),
  );
  ctx.drawImage(image, 0, 0);

  const text = post.data.title;
  const maxWidth = 700;
  const lineHeight = 80;
  const x = 520;
  const y = 270;

  ctx.font = &quot;80px MyFont&quot;;
  ctx.fillStyle = &quot;black&quot;;
  wrapText(ctx, text, x, y, maxWidth, lineHeight);

  if (!fs.existsSync(OUT_DIR)) {
    fs.mkdirSync(OUT_DIR);
  }

  await PImage.encodePNGToStream(
    pImage,
    fs.createWriteStream(path.join(OUT_DIR, `${post.slug}.png`)),
  );
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(&quot; &quot;);
  let line = &quot;&quot;;
  let testLine, metrics, testWidth;

  for (let n = 0; n &lt; words.length; n++) {
    testLine = line + words[n] + &quot; &quot;;
    metrics = ctx.measureText(testLine);
    testWidth = metrics.width;

    if (testWidth &gt; maxWidth &amp;&amp; n &gt; 0) {
      ctx.fillText(line, x, y);
      line = words[n] + &quot; &quot;;
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}
</code></pre>
<h2>The Result</h2>
<p>Now we can call <code>generateOGImage(myPost)</code> and it will generate a unique og image for the supplied post. The supplied
post&#39;s title will be drawn on the image. Using this code on the blog post you are currently reading will generate the
below image.</p>
<img class="pure-img" src="/images/og-images/generate-og-images-for-blog-posts.png"  alt="the og:image for this blog"/>

<p>Unfortunately as you can see from the image, the library we used (<code>PureImage</code>) isn&#39;t great at rendering fonts. So the font 
looks a little choppy. Potentially a different library would do a better job. Alternatively we could use a tool like 
webdriver.io or selenium to render the template as html and save it as an image which may yield better results. For me
however, the current implementation will suffice.</p>
</p>
                <footer>
                    <p>Until next time,</p>
                    <p>â€” Brian</p>
                </footer>
            </article>
        </div>
    </main>
    <footer class="site-footer">
    <div class="container">
        <p>Since August 4th, 2023. All words by Brian Douglas.</p>
    </div>
</footer>
</div>

<script>
    !function (e, t) {
        "function" == typeof define && define.amd ? define(["exports"], t) : t("undefined" != typeof exports ? exports : e.microlight = {})
    }(this, function (e) {
        var t, n, o, i = window, r = document, a = "appendChild", l = "test", s = function (e, s = {
            keywords: "font-weight:bold;",
            punctuation: "font-style:bold;",
            strings: "font-style:italic;",
            comments: "font-style:italic;"
        }) {
            for (t = 0, n = e ? r.getElementsByClassName(e || "microlight") : r.getElementsByTagName("pre"); o = n[t++];) {
                var c, d, u, f, g, m = o.textContent, h = 0, p = m[0], y = 1, b = o.innerHTML = "", _ = 0,
                    w = /(\d*\, \d*\, \d*)(, ([.\d]*))?/g.exec(i.getComputedStyle(o).color);
                for (w[1], w[3]; d = c, c = _ < 7 && "\\" == c ? 1 : y;) {
                    if (y = p, p = m[++h], f = b.length > 1, !y || _ > 8 && "\n" == y || [/\S/[l](y), 1, 1, !/[$\w]/[l](y), ("/" == c || "\n" == c) && f, '"' == c && f, "'" == c && f, m[h - 4] + d + c == "-->", d + c == "*/"][_]) for (b && (o[a](g = r.createElement("span")).setAttribute("style", ["", s.keywords, s.punctuation, s.strings, s.comments,][_ ? _ < 3 ? 2 : _ > 6 ? 4 : _ > 3 ? 3 : +/^(a(bstract|lias|nd|rguments|rray|s(m|sert)?|uto)|b(ase|egin|ool(ean)?|reak|yte)|c(ase|atch|har|hecked|lass|lone|ompl|onst|ontinue)|de(bugger|cimal|clare|f(ault|er)?|init|l(egate|ete)?)|do|double|e(cho|ls?if|lse(if)?|nd|nsure|num|vent|x(cept|ec|p(licit|ort)|te(nds|nsion|rn)))|f(allthrough|alse|inal(ly)?|ixed|loat|or(each)?|riend|rom|unc(tion)?)|global|goto|guard|i(f|mp(lements|licit|ort)|n(it|clude(_once)?|line|out|stanceof|t(erface|ernal)?)?|s)|l(ambda|et|ock|ong)|m(icrolight|odule|utable)|NaN|n(amespace|ative|ext|ew|il|ot|ull)|o(bject|perator|r|ut|verride)|p(ackage|arams|rivate|rotected|rotocol|ublic)|r(aise|e(adonly|do|f|gister|peat|quire(_once)?|scue|strict|try|turn))|s(byte|ealed|elf|hort|igned|izeof|tatic|tring|truct|ubscript|uper|ynchronized|witch)|t(emplate|hen|his|hrows?|ransient|rue|ry|ype(alias|def|id|name|of))|u(n(checked|def(ined)?|ion|less|signed|til)|se|sing)|v(ar|irtual|oid|olatile)|w(char_t|hen|here|hile|ith)|xor|yield)$/[l](b) : 0]), g[a](r.createTextNode(b))), u = _ && _ < 7 ? _ : u, b = "", _ = 11; ![1, /[\/{}[(\-+*=<>:;|\\.,?!&@~]/[l](y), /[\])]/[l](y), /[$\w]/[l](y), "/" == y && u < 2 && "<" != c, '"' == y, "'" == y, y + p + m[h + 1] + m[h + 2] == "<!--", y + p == "/*", y + p == "//", "#" == y][--_];) ;
                    b += y
                }
            }
        };
        e.reset = s, "complete" == r.readyState ? s() : i.addEventListener("load", function () {
            s()
        }, 0)
    });
</script>
<script src="/scripts/chicken-and-magpie.js"></script>
</body>
</html>