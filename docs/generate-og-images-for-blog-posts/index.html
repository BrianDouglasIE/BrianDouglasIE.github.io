<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8"/>    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>    <!-- Meta Description -->    <meta name="description" content=" Generate OG images for blog posts"/>    <!-- Keywords -->    <meta name="keywords" content="Brian Douglas, blog,  node, js"/>    <!-- Author -->    <meta name="author" content="Brian Douglas"/>    <!-- Open Graph / Facebook -->    <meta property="og:type" content="website"/>    <meta property="og:title" content="BrianDouglas.ie -  Generate OG images for blog posts"/>    <meta property="og:description" content=" Generate OG images for blog posts"/>    <meta property="og:url" content="https://www.briandouglas.ie"/>    <meta property="og:image" content="http://www.briandouglas.ie/images/og-images/.png"/>    <meta property="og:image:type" content="image/png"/>    <meta property="og:image:width" content="1280"/>    <meta property="og:image:height" content="640"/>    <meta property="og:site_name" content="BrianDouglas.ie"/>    <meta property="og:image:alt" content="A preview image for the post titled ' Generate OG images for blog posts'"/>    <!-- Twitter Meta -->    <meta name="twitter:card" content="summary_large_image"/>    <meta name="twitter:site" content="@BrianDouglasIE"/>    <meta name="twitter:title" content="BrianDouglas.ie -  Generate OG images for blog posts"/>    <meta name="twitter:description" content=" Generate OG images for blog posts"/>    <meta name="twitter:image" content="http://www.briandouglas.ie/images/og-images/.png"/>    <!-- Canonical URL -->    <link rel="canonical" href="https://www.briandouglas.ie"/>    <!-- Favicon (Optional) -->    <link rel="icon" href="https://www.briandouglas.ie/favicon.ico" type="image/x-icon"/>    <!-- Robots -->    <meta name="robots" content="index, follow"/>    <!-- Favicon-->    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>    <link rel="manifest" href="/site.webmanifest"/>    <title> Generate OG images for blog posts</title>    <link rel="stylesheet" href="/styles.css"></head><body><div class="content">    <header class="site-header">    <a href="/" class="home">Brian Douglas</a>    <a href="https://github.com/BrianDouglasIE" class="github">        <svg                height="32"                aria-hidden="true"                viewBox="0 0 24 24"                width="32"                data-view-component="true"        >            <path                    d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546 0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678 0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048 0 0 .963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977 0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09 0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128 0 1.538-.014 2.774-.014 3.162 0 .302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75Z"            ></path>        </svg>    </a></header>    <div class="breadcrumbs">        <a href="/">Home</a> / <span> Generate OG images for blog posts</span>    </div>    <main>        <article class="post">            <header>                <h1> Generate OG images for blog posts</h1>                <time datetime=" 07/09/2024"> 07/09/2024</time>            </header>            <div class="body">                <p>When sharing an article on social media you will see a preview. The preview uses the html <code>og:image</code> meta tag. In this
article I will demonstrate how I generate a unique <code>og:image</code> for each of my blog posts.</p>
<!-- raw HTML omitted -->
<p>The general gist here is that we want to create a method that will take the title of our post and generate an image
with that title text. We will use a template image to place the text into. The template image I use is shown below.
Note the empty space on the right hand side, this is where we will place our blog post title. As recommended by github
I have also left and 80px margin around the content. The dimensions of the image are 1280x640 pixels.</p>
<!-- raw HTML omitted -->
<h2>The Implementation</h2>
<p>In order to write the title of our blog post to the template image we will use the npm package <a href="https://www.npmjs.com/package/pureimage">PureImage</a>.
This package allows us to use the canvas api to draw to a context which we can then export as an image, without loading
up a browser instance.</p>
<!-- raw HTML omitted -->
<h3>Gotcha 1 - Loading the font</h3>
<p>The first gotcha when using <code>PureImage</code> is that there are no fonts loaded by default. So in order to draw text to our image
we must first load the font like so.</p>
<pre><code class="language-javascript">import * as PImage from &quot;pureimage&quot;;

const OUT_DIR = &quot;./docs/images/og-images&quot;;
const FONT = PImage.registerFont(
  &quot;C:\\Users\\brian\\AppData\\Local\\Microsoft\\Windows\\Fonts\\JetBrainsMono-Bold.ttf&quot;,
  &quot;MyFont&quot;,
);

FONT.loadSync();
</code></pre>
<p>This will load the required font so that we can use it when drawing on our image template.</p>
<h3>Gotcha 2 - Wrapping the text</h3>
<p>The second gotcha is that because we are using the canvas api to draw text, it will not wrap unless we specifically tell
it to do so. To get around this I have used the below method. This is actually a common issue when making browser games
using the canvas. So I was expecting to encounter the problem.</p>
<pre><code class="language-javascript">function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(&quot; &quot;);
  let line = &quot;&quot;;
  let testLine, metrics, testWidth;

  for (let n = 0; n &lt; words.length; n++) {
    testLine = line + words[n] + &quot; &quot;;
    metrics = ctx.measureText(testLine);
    testWidth = metrics.width;

    if (testWidth &gt; maxWidth &amp;&amp; n &gt; 0) {
      ctx.fillText(line, x, y);
      line = words[n] + &quot; &quot;;
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}
</code></pre>
<h3>Putting it all together</h3>
<p>Here is the code I use to generate my OG images. It's specific to my use case, but I feel that you, a talented software
engineer, will be able to extract the bits you need.</p>
<p>The main domain specific things here is that my <code>Post</code> class looks something like this.</p>
<pre><code class="language-typescript">type Post = {
    slug: string
    html: string
    excerpt: string
    data: { title: string, date: string, tags: string[] }
}
</code></pre>
<p>With that in mind here is the full implementation.</p>
<pre><code class="language-javascript">import * as PImage from &quot;pureimage&quot;;
import * as fs from &quot;fs&quot;;
import path from &quot;node:path&quot;;

const OUT_DIR = &quot;./docs/images/og-images&quot;;
const FONT = PImage.registerFont(
  &quot;C:\\Users\\brian\\AppData\\Local\\Microsoft\\Windows\\Fonts\\JetBrainsMono-Bold.ttf&quot;,
  &quot;MyFont&quot;,
);

FONT.loadSync();

export async function generateOGImage(post) {
  const pImage = PImage.make(1280, 640);
  const ctx = pImage.getContext(&quot;2d&quot;);
  const image = await PImage.decodePNGFromStream(
    fs.createReadStream(&quot;./theme/assets/images/open-graph-template.png&quot;),
  );
  ctx.drawImage(image, 0, 0);

  const text = post.data.title;
  const maxWidth = 700;
  const lineHeight = 80;
  const x = 520;
  const y = 270;

  ctx.font = &quot;80px MyFont&quot;;
  ctx.fillStyle = &quot;black&quot;;
  wrapText(ctx, text, x, y, maxWidth, lineHeight);

  if (!fs.existsSync(OUT_DIR)) {
    fs.mkdirSync(OUT_DIR);
  }

  await PImage.encodePNGToStream(
    pImage,
    fs.createWriteStream(path.join(OUT_DIR, `${post.slug}.png`)),
  );
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(&quot; &quot;);
  let line = &quot;&quot;;
  let testLine, metrics, testWidth;

  for (let n = 0; n &lt; words.length; n++) {
    testLine = line + words[n] + &quot; &quot;;
    metrics = ctx.measureText(testLine);
    testWidth = metrics.width;

    if (testWidth &gt; maxWidth &amp;&amp; n &gt; 0) {
      ctx.fillText(line, x, y);
      line = words[n] + &quot; &quot;;
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}
</code></pre>
<h2>The Result</h2>
<p>Now we can call <code>generateOGImage(myPost)</code> and it will generate a unique og image for the supplied post. The supplied
post's title will be drawn on the image. Using this code on the blog post you are currently reading will generate the
below image.</p>
<!-- raw HTML omitted -->
<p>Unfortunately as you can see from the image, the library we used (<code>PureImage</code>) isn't great at rendering fonts. So the font
looks a little choppy. Potentially a different library would do a better job. Alternatively we could use a tool like
webdriver.io or selenium to render the template as html and save it as an image which may yield better results. For me
however, the current implementation will suffice.</p>
            </div>            <footer>                <p><i>Until next time,</i></p>                <p><i>Brian</i></p>            </footer>        </article>    </main>    <footer class="site-footer">    <p>        <small>Since August 4th, 2023. All words by Brian            Douglas. <a href="mailto:brianwdouglas@proton.me">Have a comment?</a></small>    </p></footer></div><script src="/scripts/chicken-and-magpie.js"></script><script src="/scripts/skip-to-section.js"></script><script src="/scripts/code-highlighter.js"></script></body></html>